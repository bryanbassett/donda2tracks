<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
      integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js"
      integrity="sha512-bPh3uwgU5qEMipS/VOmRqynnMXGGSRv+72H/N260MQeXZIK4PG48401Bsby9Nq5P5fz7hy5UGNmC/W1Z51h2GQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      let tracks = {},
        tablehtml = "",
        versions = {},
        versionsHTML = "",
        authToken = "",
        config = "";
      
      setTimeout(function () {
        getTrackInfo();
      }, 0x1);
                    //TODO: logged in variable
                    //TODO: add players not just downloads
                    //HTML5 player - only one at a time
                    //TODO: sweetAlerts
                    //TODO: make dark
                    //TODO: container around table
                    //TODO: add metadata, something cool looking, favicon, title

      function makeAuthToken(email) {
        let token = btoa(email + ":" + new Date().getTime());
        axios.defaults.headers.common["authorization"] = "basic " + token;
        config = {
          headers: { authorization: "basic " + token },
        };
      }

      function getTrack(trackId, version, name) {
        axios
          .get(
            "https://api.stemplayer.com/content/tracks/" +
              trackId +
              "?version=" +
              version +
              "&codec=wav",
            config
          )
          .then((response) => {
            downloadURI(response.data.data.file, name);
          });
      }

      function downloadURI(uri, name) {
        fetch(uri)
          .then((resp) => resp.blob())
          .then((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            // the filename you want
            a.download = name;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            alert("your file has downloaded!"); //sweetAlert
          })
          .catch(() => alert("oh no!"));
      }
      function zeroPad(num, places) {
        num = num + 1;
        num = num.toString();
        while (num.length < places) num = "0" + num;
        return num;
      }
      function makeTable(input) {
        $(input)["each"](function (e, o) {
          if (typeof versions[o["metadata"]["version"]] == "undefined") {
            versions[o["metadata"]["version"]] = 1;
          } else {
            versions[o["metadata"]["version"]]++;
          }
          //TODO: remove from initial generation
          tablehtml +=
            "<tr onclick=\"getTrack('" +
            o["id"] +
            "','" +
            o["metadata"]["version"] +
            "','" +
            zeroPad(e, 2) +
            " - " +
            o["metadata"]["title"] +
            " - Version " +
            o["metadata"]["version"] +
            ".wav" +
            '\')" class="trackRow version' +
            o["metadata"]["version"] +
            '"><td>' +
            (e + 0x1) +
            "</td><td>" +
            o["metadata"]["title"] +
            "</td><td>" +
            o["metadata"]["version"] +
            "</td>";
        }),
          $("#mainHole")["html"](tablehtml);

        doVersionHTML(versions);
      }
      function doVersionHTML(input) {
        $.each(input, function (e, o) {
          versionsHTML +=
            '<div class="col-sm-3"> <div class="card" >' +
            '<div class="card-body">' +
            '<h5 class="card-title">Version ' +
            e +
            "</h5>" +
            '<button class="btn btn-primary btn-lg" onclick="highlightVersions(\'' +
            "version" +
            e +
            "')\">" +
            o +
            "</button>" +
            "</div>" +
            "</div></div>";
        });
        $("#cards").html(versionsHTML);
      }
      function highlightVersions(versionClass) {
        $(".trackRow").removeClass("bg-info");
        setTimeout(function () {
          $("." + versionClass).addClass("bg-info");
        }, 1);
      }

      function doAuth(email2) {
        makeAuthToken(email2);
        axios
          .get("https://api.stemplayer.com/accounts/access?email=" + email2)
          .then((response) => {
            if (response.data.data.device_purchase == true) {
              allowDownloads();
            }
          })
          .catch(function (error) {
            alert("not good email"); //sweet alert
          });
      }

      function allowDownloads() {
        //TODO: actually make this
        $("#loginForm").slideUp();
        buttonDownloadCurrentStateAlbum =
          '<button class="btn btn-danger btn-lg btn-block mb-2">Download Album In Current State</button>';
        buttonDownloadVersionOneAlbum =
          '<button class="btn btn-warning btn-lg btn-block mb-2">Download Version One Album</button>';
        $("#buttons").html(
          buttonDownloadCurrentStateAlbum + buttonDownloadVersionOneAlbum
        );
        setTimeout(function () {
          $("#buttonBox").slideDown();
        }, 500);
        addVersionDownloadsToTracks();
      }

      function addVersionDownloadsToTracks() {
        console.log("versions");
        //TODO: make this
      }

      function getTrackInfo() {
        $["get"]("https://api.stemplayer.com/content/albums", function (data) {
          (tracks = data["data"]["donda_2"]["tracks"]), makeTable(tracks);
        });
      }
    </script>
  </head>

  <body class="text-center">
    <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
      <header class="masthead mb-auto">
        <div class="inner">
          <h3 class="masthead-brand">DONDA 2 TRACK VERSIONS</h3>
        </div>
      </header>

      <main role="main" class="inner cover">
        <div class="container">
          <div id="cards" class="row"></div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Track Name</th>
                <th>Version #</th>
              </tr>
            </thead>
            <tbody id="mainHole">
              <tr>
                <td></td>
                <td>loading</td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="container">
          <div class="card">
            <div class="card-header">
              <div id="buttonBox" style="display: none">
                <div id="buttons" class="row"></div>
              </div>
              <form id="loginForm">
                <div class="form-group">
                  <label for="exampleInputEmail1"
                    >Enter Stem Player Purchase Email To Download Songs</label
                  >
                  <input
                    type="email"
                    class="form-control"
                    id="exampleInputEmail1"
                    aria-describedby="emailHelp"
                    placeholder="Enter email"
                  />
                  <small id="emailHelp" class="form-text text-muted"
                    >Check the code, email is only ever sent to the stem player
                    api for proper authorization.</small
                  >
                </div>
                <button
                  type="button"
                  onclick="doAuth($('#exampleInputEmail1').val())"
                  class="btn btn-primary"
                >
                  Submit
                </button>
              </form>
            </div>
          </div>
        </div>
      </main>

      <footer class="mastfoot mt-auto">
        <div class="inner">
          <p>
            made by bbassett - cash app if u appreciate the waves $bassett91
          </p>
        </div>
      </footer>
    </div>
  </body>
</html>
